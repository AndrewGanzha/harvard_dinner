services:
  backend:
    build:
      context: .
      target: base
    container_name: harvard-plate-backend
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=development
      - PORT=3001
      - FRONTEND_URL=http://localhost:3000
      - GIGACHAT_CREDENTIALS=${GIGACHAT_CREDENTIALS}
      - GIGACHAT_MODEL=GigaChat
      - GIGACHAT_SCOPE=${GIGACHAT_SCOPE}
      - GIGACHAT_API_URL=${GIGACHAT_API_URL}
      # Внутри docker-сети используем Kong
      - SUPABASE_URL=http://supabase-kong:8000
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - SUPABASE_JWT_SECRET=${SUPABASE_JWT_SECRET}
    volumes:
      - .:/app
      - /app/node_modules
    command: npm run dev
    restart: unless-stopped
    depends_on:
      - supabase-kong
    networks:
      - harvard-network

  supabase-db:
    image: supabase/postgres:latest
    container_name: supabase-db
    environment:
      - POSTGRES_PASSWORD=${SUPABASE_DB_PASSWORD}
      - POSTGRES_USER=${SUPABASE_DB_USER}
      - POSTGRES_DB=${SUPABASE_DB_NAME}
      - JWT_SECRET=${SUPABASE_JWT_SECRET}
    ports:
      - "5432:5432"
    volumes:
      - supabase_db_data:/var/lib/postgresql/data
    networks:
      - harvard-network

  supabase-auth:
    image: supabase/gotrue:latest
    container_name: supabase-auth
    depends_on:
      - supabase-db
    environment:
      - GOTRUE_SITE_URL=http://localhost:3000
      - GOTRUE_API_HOST=localhost
      - GOTRUE_DB_DRIVER=postgres
      - GOTRUE_DB_DATABASE_URL=postgres://${SUPABASE_DB_USER}:${SUPABASE_DB_PASSWORD}@supabase-db:5432/${SUPABASE_DB_NAME}
      - GOTRUE_JWT_SECRET=${SUPABASE_JWT_SECRET}
      - GOTRUE_JWT_EXP=3600
      - GOTRUE_DISABLE_SIGNUP=false
      - GOTRUE_EXTERNAL_EMAIL_ENABLED=true
      - GOTRUE_MAILER_AUTOCONFIRM=true
    networks:
      - harvard-network

  supabase-rest:
    image: supabase/postgrest:latest
    container_name: supabase-rest
    depends_on:
      - supabase-db
    environment:
      - PGRST_DB_URI=postgres://${SUPABASE_DB_USER}:${SUPABASE_DB_PASSWORD}@supabase-db:5432/${SUPABASE_DB_NAME}
      - PGRST_DB_SCHEMA=public
      - PGRST_DB_ANON_ROLE=anon
      - PGRST_JWT_SECRET=${SUPABASE_JWT_SECRET}
    networks:
      - harvard-network

  supabase-realtime:
    image: supabase/realtime:latest
    container_name: supabase-realtime
    depends_on:
      - supabase-db
    environment:
      - DB_HOST=supabase-db
      - DB_PORT=5432
      - DB_NAME=${SUPABASE_DB_NAME}
      - DB_USER=${SUPABASE_DB_USER}
      - DB_PASSWORD=${SUPABASE_DB_PASSWORD}
      - PORT=4000
      - JWT_SECRET=${SUPABASE_JWT_SECRET}
      - SECRET_KEY_BASE=${REALTIME_SECRET_KEY_BASE}
    networks:
      - harvard-network

  supabase-storage:
    image: supabase/storage-api:latest
    container_name: supabase-storage
    depends_on:
      - supabase-db
      - supabase-rest
    environment:
      - ANON_KEY=${SUPABASE_ANON_KEY}
      - SERVICE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - POSTGREST_URL=http://supabase-rest:3000
      - PGRST_JWT_SECRET=${SUPABASE_JWT_SECRET}
      - DATABASE_URL=postgres://${SUPABASE_DB_USER}:${SUPABASE_DB_PASSWORD}@supabase-db:5432/${SUPABASE_DB_NAME}
      - FILE_STORAGE_BACKEND_PATH=/var/lib/storage
      - STORAGE_BACKEND=file
      - REGION=local
      - GLOBAL_S3_BUCKET=stub
      - TENANT_ID=stub
      - AUTH_JWT_SECRET=${SUPABASE_JWT_SECRET}
    volumes:
      - supabase_storage_data:/var/lib/storage
    networks:
      - harvard-network

  supabase-meta:
    image: supabase/postgres-meta:latest
    container_name: supabase-meta
    depends_on:
      - supabase-db
    environment:
      - PG_META_PORT=8080
      - PG_META_DB_HOST=supabase-db
      - PG_META_DB_PORT=5432
      - PG_META_DB_NAME=${SUPABASE_DB_NAME}
      - PG_META_DB_USER=${SUPABASE_DB_USER}
      - PG_META_DB_PASSWORD=${SUPABASE_DB_PASSWORD}
    networks:
      - harvard-network

  supabase-studio:
    image: supabase/studio:latest
    container_name: supabase-studio
    depends_on:
      - supabase-meta
      - supabase-kong
    ports:
      - "3000:3000"
    environment:
      - STUDIO_PG_META_URL=http://supabase-meta:8080
      - SUPABASE_URL=http://supabase-kong:8000
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - AUTH_JWT_SECRET=${SUPABASE_JWT_SECRET}
    networks:
      - harvard-network

  supabase-kong:
    image: kong:2.8
    container_name: supabase-kong
    depends_on:
      - supabase-auth
      - supabase-rest
      - supabase-realtime
      - supabase-storage
    ports:
      - "8000:8000"
      - "8001:8001"
    environment:
      - KONG_DATABASE=off
      - KONG_DECLARATIVE_CONFIG=/etc/kong/kong.yml
      - KONG_PROXY_LISTEN=0.0.0.0:8000
      - KONG_ADMIN_LISTEN=0.0.0.0:8001
      - KONG_LOG_LEVEL=warn
      - KONG_PLUGINS=key-auth,acl,cors
    volumes:
      - ./docker/kong.yml:/etc/kong/kong.yml:ro
    networks:
      - harvard-network

volumes:
  supabase_db_data:
  supabase_storage_data:

networks:
  harvard-network:
    driver: bridge
